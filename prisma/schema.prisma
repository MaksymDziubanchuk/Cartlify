datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  ADMIN
  ROOT
}

enum UserTokenType {
  VERIFY_EMAIL
  RESET_PASSWORD
}

enum ReviewVoteAction {
  UP
  DOWN
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum PriceChangeMode {
  percent
  fixed
}

enum AdminAuditEntityType {
  user
  product
  category
  order
  review
  other
}

enum AdminAuditAction {
  USER_ROLE_CHANGE
  PRODUCT_CREATE
  PRODUCT_UPDATE
  PRODUCT_DELETE
  PRODUCT_PRICE_BULK_UPDATE
  ORDER_STATUS_CHANGE
  CATEGORY_UPDATE
  REVIEW_DELETE
  OTHER
}


enum ChatStatus {
  open
  closed
}

enum ChatType {
  bot
  admin
}

enum ChatMessageSenderType {
  user
  admin
  bot
  system
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String   
  role          Role     @default(USER)

  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  name          String?
  avatarUrl     String?
  locale        String?
  phone         String?

  userTokens    UserToken[]
  loginLogs     LoginLog[]
  reviews          Review[]
  votes     ReviewVote[]
  favorites Favorite[]
  orders    Order[]
  productPriceChangeLogs ProductPriceChangeLog[]
  adminAuditLogs AdminAuditLog[]
  chatThreads ChatThread[]
  chatMessages ChatMessage[]

  @@map("users")
  @@index([createdAt])
  @@index([isVerified, createdAt])
}

model UserToken {
  id        Int           @id @default(autoincrement())
  userId    Int
  type      UserTokenType
  token     String        @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime      @default(now())

  user      User          @relation(fields: [userId], references: [id])

  @@map("user_tokens")
  @@index([userId, type, createdAt])
}

model LoginLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  email     String
  role      Role
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@map("login_logs")
  @@index([userId, createdAt])
  @@index([email, createdAt])
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String
  slug        String     @unique
  description String?

  parentId    Int?
  parent      Category?  @relation("CategoryToSubcategories", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryToSubcategories")

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products    Product[]

  @@map("categories")
  @@index([parentId])
  @@index([slug])
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  price       Decimal  @db.Decimal(10, 2)

  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])

  views       Int      @default(0)

  popularity  Int      @default(0)
  popularityOverride      Int?
  popularityOverrideUntil DateTime?

  avgRating   Decimal        @db.Decimal(3, 2) @default(0)
  reviewsCount Int           @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reviews          Review[]
  favorites        Favorite[]
  orderItems       OrderItem[]
  priceChangeLogs  ProductPriceChangeLog[]
  images      ProductImage[]

  @@map("products")
  @@index([categoryId])
  @@index([price])
  @@index([createdAt])
  @@index([name])
  @@index([popularity])
  @@index([views])
}

model ProductImage {
  id        Int      @id @default(autoincrement())

  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String
  publicId  String?
  alt       String?

  position  Int      @default(0)
  isPrimary Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_images")
  @@index([productId, position])
}

model Review {
  id        Int      @id @default(autoincrement())

  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating    Int

  upVotes   Int      @default(0)
  downVotes Int      @default(0)

  comment   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes     ReviewVote[]

  @@map("reviews")
  @@index([productId])
  @@index([userId])
  @@unique([userId, productId])
}

model ReviewVote {
  id        Int              @id @default(autoincrement())

  reviewId  Int
  review    Review           @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId    Int
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  action    ReviewVoteAction

  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@map("review_votes")
  @@unique([userId, reviewId])
  @@index([reviewId])
}

model Favorite {
  id        Int      @id @default(autoincrement())

  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("favorites")
  @@unique([userId, productId])
  @@index([productId])
}

model Order {
  id      Int         @id @default(autoincrement())

  userId  Int
  user    User        @relation(fields: [userId], references: [id], onDelete: Restrict)

  status  OrderStatus @default(pending)
  confirmed Boolean     @default(false)

  total    Decimal    @db.Decimal(10, 2)

  shippingAddress String?
  note            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     OrderItem[]

  @@map("orders")
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model OrderItem {
  id        Int      @id @default(autoincrement())

  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
}

model ChatThread {
  id        String     @id @default(uuid()) @db.Uuid

  userId    Int
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      ChatType
  status    ChatStatus @default(open)

  lastMessageAt      DateTime @default(now())
  unreadCount        Int      @default(0)
  lastMessagePreview String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  ChatMessage[]

  @@map("chat_threads")
  @@index([userId, status, type, lastMessageAt])
}

model ChatMessage {
  id       Int         @id @default(autoincrement())

  threadId String @db.Uuid
  thread   ChatThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  senderId Int?
  sender   User?       @relation(fields: [senderId], references: [id], onDelete: SetNull)

  senderType ChatMessageSenderType

  content    String

  isRead     Boolean    @default(false)
  createdAt  DateTime   @default(now())

  @@map("chat_messages")
  @@index([threadId, createdAt])
}

model ProductPriceChangeLog {
  id Int @id @default(autoincrement())

  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  actorId Int
  actor   User  @relation(fields: [actorId], references: [id], onDelete: Restrict)

  oldPrice Decimal @db.Decimal(10, 2)
  newPrice Decimal @db.Decimal(10, 2)

  mode  PriceChangeMode
  value Decimal       @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@map("product_price_change_logs")
  @@index([productId, createdAt])
  @@index([actorId, createdAt])
}

model AdminAuditLog {
  id Int @id @default(autoincrement())

  actorId   Int
  actor     User   @relation(fields: [actorId], references: [id], onDelete: Restrict)

  actorRole Role

  entityType AdminAuditEntityType
  entityId   Int?

  action   AdminAuditAction
  meta     Json?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@map("admin_audit_log")
  @@index([actorId, createdAt])
  @@index([entityType, entityId])
}
